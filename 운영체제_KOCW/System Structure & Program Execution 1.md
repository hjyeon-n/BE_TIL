# System Structure & Program Execution 1

### 컴퓨터 시스템의 구조 🖥

컴퓨터 시스템의 구조는 크게 컴퓨터 내부장치와 컴퓨터 외부 장치로 구성할 수 있다. 

+ 입력: 컴퓨터 내부로 데이터가 들어오는 것
+ 출력: 컴퓨터 외부장치로 데이터가 나가는 것

메모리 및 입출력 장치 등의 하드웨어 장치에는 **컨트롤러**가 있다. 컨트롤러는 일종의 작은 CPU로서, 장치들을 제어하는 역할을 한다.

ex) 디스크 컨트롤러: 디스크의 헤드를 움직이고 어떤 데이터를 읽을지 제어한다.

CPU와 disk 속도 차이가 크기 때문에 컨트롤러를 사용해 장치를 제어한다고 생각하면 된다! 😏

![image](https://user-images.githubusercontent.com/62419307/98951558-bed82080-253d-11eb-82c3-2a2c4b19b353.png)

<br>

### CPU 연산과 I/O연산

🙋‍♀️CPU... 내가 걔를 잘 아는데 컴퓨터의 두뇌라며?! 라고 생각했다면 반은 맞고 반은 틀리다! 🤓

빠른 속도로 처리하는 계산 능력은 있지만, 인간의 두뇌처럼 스스로 판단을 내리진 못한다. 👀

즉, **CPU는 매 시점 메모리의 특정 주소에 존재하는 명령을 하나씩 읽어와 실행할 뿐이다!** 이때, CPU가 수행해야 할 메모리 주소를 담고 있는 레지스터를 프로그램 카운터(Program Counter: PC)라고 한다.

그러면 컴퓨터 시스템의 동작이 CPU에 의해서만 이루어질까? 그럴듯 하지만 아니다. 디스크에서 파일을 읽어오기도 하고 키보드로 입력을 받기도 한다. 따라서 컴퓨터 시스템 동작을 이해하기 위해서는 전체적인 시스템 구조를 먼저 파악해야 한다.

![image](https://user-images.githubusercontent.com/62419307/98953839-87b73e80-2540-11eb-8fd4-20358c20ce81.png)



이전에 설명했듯, 입출력 장치별로 작은 CPU와 메모리가 있는데 이를 각각 **입출력 컨트롤러**와 **로컬버퍼**라고 부른다. 따라서, 입출력 장치들의 I/O 연산은 입출력 컨트롤러가 담당하고, 컴퓨터 내에서 수행되는 연산은 메인 CPU가 담당한다. 이때, 입출력 장치와 메인 CPU는 각각의 일이 다른 곳에서 발생하므로 동시 수행이 가능하다. 

<br>

#### 그러면 어떻게 수행이 되는 거야? 🤷‍♀️

1. 프로그램 A가 수행 중에 디스크에서 데이터를 읽어오라는 명령을 내린다.
2. 디스크 컨트롤러가 물리적인 디스크에서 내용을 읽어 이를 로컬버퍼에 저장한다.
3. 원하는 데이터를 로컬버퍼로 다 읽어오고 나면 B는 메인 CPU에서 다음 일을 수행할 수 있다.

이 과정을 CPU가 다 지켜 보고 있을까? 아니다!🙅‍♀️ CPU는 일만 시켜놓고 다른 일을 수행 중이다. 그렇기 때문에 사용자 입장에서는 interactive하게 움직일 수 있다. 만약 I/O 등 작업이 끝나면, **장치에 있는 컨트롤러가 인터럽트를 발생시켜 CPU에 보고한다.** 

CPU 옆에는 **인터럽트 라인(interrupt line)**이 있어서 명령 하나를 수행할 때마다 인터럽트가 발생했는지 확인하고, 인터럽트가 발생했으면 다음 명령을 수행하기 전에 인터럽트 처리를 하게 된다.

<br>

### 인터럽트의 일반적 기능

이제 인터럽트가 무엇이고 무슨 일을 하는지에 대해 알아보자.🔍

운영체제 커널에는 인터럽트가 들어왔을 때 해야 할 일이 미리 다 프로그래밍되어 그 코드가 보관돼 있다. 

앞의 예처럼 디스크 컨트롤러가 인터럽트를 발생시키면 CPU는 하던 일을 잠시 멈추고, 인터럽트가 발생했을 때 수행하도록 정의된 코드를 찾아서 수행한다. 

이 인터럽트에는 **하드웨어 인터럽트**와 **소프트웨어 인터럽트**가 있다. 인터럽트 발생 여부를 알리는 것은 동일하지만 하드웨어 인터럽트는 컨트롤러 등 하드웨어 장치가 인터럽트 라인을 세팅하는 반면에 소프트웨어 인터럽트는 소프트웨어가 그 일을 수행한다는 차이점이 있다.

1. 인터럽트가 발생하면, CPU는 하던 일을 머무고 운영체제 커널 내에서 해당 인터럽트의 처리를 위해 정의된 코드를 찾게 된다.
2. 운영체제는 이처럼 할 일을 쉽게 찾아가기 위해 **인터럽트 벡터(interrupt vector)**를 가지고 있다. 
3. **인터럽트 처리루틴**을 통해 해당 인터럽트 처리를 완료하고, 원래 수행하던 작업으로 돌아가야 하므로 인터럽트 처리 전 진행 중이던 작업이 무엇이었는지 반드시 저장해야 한다. 운영체제는 이러한 정보를 저장하기 위한 장소를 별도로 가지고 있다.

➕ 용어 정리

+ **인터럽트 벡터** 

  인터럽트 종류마다 번호를 정해서, 번호에 따라 처리해야 할 코드가 위치한 부분을 가리키고 있는 자료구조

  → 인터럽트마다 무슨 일을 하는지 알 수 있다.

+ **인터럽트 처리루틴**

  **인터럽트 핸들러(interrupt handler)**라고도 불리며, 실제 처리해야 할 코드를 말한다.

<br>

#### 소프트웨어 인터럽트와 하드웨어 인터럽트에 대해서 더 알려줄래? 🤔

일반적으로 인터럽트라고 하면 하드웨어 인터럽트를 의미하고, 소프트웨어 인터럽트는 **트랩(trap)🧀**이라는 용어로 주로 불린다.

소프트웨어 인터럽트의 예로는 **예외상황(exception)**과 **시스템 콜(system call)**이 있다.

+ 예외상황

  사용자 프로그램이 0으로 나누는 연산 등 비정상적인 작업을 시도하거나, 자신의 메모리 영역 바깥에 접근하려는 시도 등 권한이 없는 작업을 시도할 때 이에 대한 처리를 위해 발생시키는 인터럽트이다.

+ 시스템 콜

  사용자 프로그램이 운영체제 내부에 정의된 코드를 실행하고 싶을 때 운영체제에 서비스를 요청하는 방법이다.

  **🤯 엥? 운영체제에 요청까지 해야 해?**

  ~~들어올 때는 자유지만, 나갈 때는 아니란다.~~

  운영체제가 프로그램에게 CPU 제어권을 부여할 때는 자유롭지만, 한 번 넘어가면 뺏을 수 없다. CPU는 이미 넘어갔기 때문이다.

  그래서 운영체제 커널에 있는 코드를 수행할 때는 인터럽트 라인 세팅을 통해 다시 운영체제에게 제어권을 넘겨줘야 한다. 

  이는 CPU의 특권명령과 일반명령의 차이와도 관련이 있다.

<br>

### CPU의 modebit

우리가 흔히 사용하는 운영체제는 여러 프로그램이 동시에 실행될 수 있는 다중 프로그래밍 환경에서 동작한다. 그러므로 충돌이나 다른 프로그램 실행 방해를 막기 위해 **커널모드(0)**와 **사용자모드(1)**로 CPU 내부에 modebit를 구분해서 두 가지 모드를 지원한다.

만약, 어떤 프로그램이 이상한 명령을 수행시켜 다른 프로그램의 메모리 영역이나 파일 영역을 침범할 수 있다. 따라서 이러한 연산은 커널모드에서만 실행하게 하여 보안성을 확보한다. 이를 위해 CPU는 보안과 관련된 명령을 수행하기 전, 모드비트를 확인한다.

+ 커널모드

  운영체제가 CPU의 제어권을 가지고 운영체제 코드를 실행하는 모드로서, 이 모드에서는 모든 종류의 명령을 다 실행할 수 있다.

  특히 시스템의 보안과 관련된 명령들을 특권명령이라고 하며, 커널모드에서만 수행할 수 있다.

+ 사용자모드

  입출력 같이 특권명령이 필요할 땐, 사용자 모드는 수행이 불가하므로 **시스템 콜**을 호출해 운영체제에 요청해야 한다. 특권명령이 끝이 나면, 다시 CPU의 제어권을 사용자 프로그램에게 넘겨서 다시 사용자 모드로 사용할 수 있다.

<br>

### DMA

원칙적으로 메모리는 CPU에 의해서만 접근할 수 있는 장치이다. 따라서 다른 장치가 메모리의 데이터에 접근하기 위해서는 CPU에게 인터럽트를 발생시켜 CPU가 이를 대행하는 식으로만 가능하다. 하지만 그랬더니... 인터럽트가 너무 많아서 CPU 업무 효율성이 떨어진다! 😒 

CPU 🤬: 안 되겠어... 나 말고 메모리에 접근이 가능한 장치를 따로 두자! 

바로 그 친구가 **DMA**! DMA는 일종의 컨트롤러로서, CPU가 입출력 장치들의 메모리 접근 요청에 의해 자주 인터럽트 당하는 것을 막아주는 역할을 한다. DMA를 사용하면 로컬버퍼에서 메모리로 읽어오는 작업을 CPU가 담당하는 것이 아니라 DMA가 대행함으로써 CPU 는 원래 하던 작업을 멈추고 인터럽트를 처리할 필요가 없어진다.

➕ 메모리 컨트롤러와는 다른 장치!

: 메모리 컨트롤러는 특정 메모리 영역에 동시 접근할 때 제어하는 장치이다.